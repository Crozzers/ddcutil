#!/bin/sh

# srcdir=/shared/playproj/i2c
# workdir=.

name=@PACKAGE_TARNAME@ 
ver="@PACKAGE_VERSION@"

obs_proj="home:rockowitz"
obs_pkg=ddcutil

echo "---------> package/upload_obsrpm"
echo "arg 0: $0"
echo "arg 1: $1"
echo "arg 2: $2"
echo "number of arguments: $#"

if [[ $# -ge 2 ]]; then 
	obs_pkg=$2
fi

srcdir=${PWD}/..
curdir=${PWD}
workdir=${PWD}/obswork

echo srcdir=$srcdir
echo workdir=$workdir
echo obs_pkg=$obs_pkg

# TODO: error if workdir exists but not a directory

if [ ! -d $workdir ]; then
  echo creating $workdir
  mkdir $workdir
else
  echo clearing $workdir
  rm -r $workdir/*
  rm -r $workdir/.osc
fi

cmd="osc checkout -o $workdir $obs_proj $obs_pkg"
echo "cmd: $cmd"
$cmd

tar_fn=ddcutil-${ver}.tar.gz

tar_fn_new=
if [ -e $workdir/$tar_fn ]; then
  echo "$tar_fn already exists"
else 
  echo "$tar_fn not checked out"
  tar_fn_new=1
fi

# Can't remove all prior versions because might delete version used by debian 
# rm -f $workdir/ddcutil*tar.gz
cp -p $srcdir/$tar_fn $workdir
cp -p $curdir/ddcutil.spec $workdir
echo "Modified $workdir:"
ls -l $workdir 

cd obswork

osc addremove 

# cmd="osc commit ddcutil-${ver}.tar.gz ddcutil.spec --message=\"new rpm build files\""
cmd="osc commit  -m \"new rpm build files for ${obs_pkg}\""
echo cmd: $cmd
$cmd

echo "Files in package ${obs_pkg} after osc commit:"
cmd="osc ls -l home:rockowitz ${obs_pkg}"
$cmd

# osc rebuild
